# Sprint S11: –ú–∞—à–∏–Ω–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ v2 - –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –§–∏—á–µ-—Ñ–ª–∞–≥–∏
- ‚úÖ `FSM_V2_ENABLED = true` - –≤–∫–ª—é—á–∞–µ—Ç FSM, —á–∞—Å—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, split/merge
- ‚úÖ `LINEAGE_V2_ENABLED = true` - –≤–∫–ª—é—á–∞–µ—Ç –ø–∞–Ω–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è

### 2. –î–æ–º–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã (`src/lib/fsm/types.ts`)
- ‚úÖ `ShipmentStatus` - —Å—Ç–∞—Ç—É—Å—ã –æ—Ç–≥—Ä—É–∑–æ–∫
- ‚úÖ `Role` - —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ `LineItem` - –ø–æ–∑–∏—Ü–∏–∏ —Å lineage –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
- ‚úÖ `LinesState` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ `TransitionKey` - –∫–ª—é—á–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- ‚úÖ `FSMEvent` - —Å–æ–±—ã—Ç–∏—è FSM
- ‚úÖ `MergeAttachTarget`, `SplitPlan` - –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è/—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
- ‚úÖ `FSMError` - —Ç–∏–ø—ã –æ—à–∏–±–æ–∫

### 3. –°—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (`src/lib/fsm/schema.ts`)
- ‚úÖ `receivePartialSchema` - —á–∞—Å—Ç–∏—á–Ω—ã–π –ø—Ä–∏—ë–º
- ‚úÖ `deliverPartialSchema` - —á–∞—Å—Ç–∏—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
- ‚úÖ `splitSchema` - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏
- ‚úÖ `mergeAttachSchema` - –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é
- ‚úÖ `confirmSchema` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

### 4. –ì—Ä–∞—Ñ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ (`src/lib/fsm/graph.ts`)
- ‚úÖ `EDGES` - –º–∞—Å—Å–∏–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- ‚úÖ `allowedTransitions()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- ‚úÖ `resolveNext()` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ Guards –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π (–¥–æ–ª–≥, —Å–≤–µ—Ä–∫–∞)

### 5. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (`src/lib/fsm/apply.ts`)
- ‚úÖ `applyOptimistic()` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ `rollback()` - –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ `isConflict()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤–µ—Ä—Å–∏–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### 6. API –≤—ã–∑–æ–≤—ã (`src/lib/fsm/api.ts`)
- ‚úÖ `fetchLines()` - –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–π
- ‚úÖ `postTransition()` - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- ‚úÖ `postReceivePartial()` - —á–∞—Å—Ç–∏—á–Ω—ã–π –ø—Ä–∏—ë–º
- ‚úÖ `postDeliverPartial()` - —á–∞—Å—Ç–∏—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
- ‚úÖ `postSplit()` - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏
- ‚úÖ `postMergeAttach()` - –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é
- ‚úÖ `postMergeDetach()` - –æ—Ç—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è

### 7. React —Ö—É–∫ (`src/lib/fsm/useFSM.ts`)
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º FSM
- ‚úÖ –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –æ—Ç–∫–∞—Ç
- ‚úÖ Idempotency –∫–ª—é—á–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö

### 8. –ú–æ–¥–∞–ª—å–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏
- ‚úÖ `ReceivePartialDialog` - —á–∞—Å—Ç–∏—á–Ω—ã–π –ø—Ä–∏—ë–º
- ‚úÖ `SplitDialog` - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å –ø–æ–º–æ—â—å—é Zod
- ‚úÖ UX –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### 9. Lineage —Å–∏—Å—Ç–µ–º–∞
- ‚úÖ `LineagePanel` - –ø–∞–Ω–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è
- ‚úÖ `LineageBadge` - –±–µ–π–¥–∂ lineage
- ‚úÖ –ì—Ä–∞—Ñ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ –∏ –ø–æ–∑–∏—Ü–∏–π
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π

### 10. System Cards
- ‚úÖ `StatusChangeCard` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ `PartialOpCard` - —á–∞—Å—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ `SplitMergeCard` - –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è/–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ –ê—É–¥–∏—Ç –≤—Å–µ—Ö FSM –æ–ø–µ—Ä–∞—Ü–∏–π

### 11. StatusActionsV2
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ACL —Å–∏—Å—Ç–µ–º–æ–π
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å useFSM —Ö—É–∫–æ–º

### 12. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —á–∞—Ç
- ‚úÖ FSM_V2_ENABLED –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ StatusActionsV2 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- ‚úÖ useFSM —Ö—É–∫
- ‚úÖ ACL –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ Real-time —Å–æ–±—ã—Ç–∏—è

## üéØ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ú–∞—à–∏–Ω–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
- **–ß–∞—Å—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: –ø—Ä–∏—ë–º –∏ –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ —á–∞—Å—Ç—è–º
- **Split/Merge**: —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–æ–∫
- **Lineage**: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
- **–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫ UI
- **–ö–æ–Ω—Ñ–ª–∏–∫—Ç-—Ä–µ–∑–æ–ª—é—à–Ω**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### ACL –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤**: –∫–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- **–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç–∫–∞–∑–∞**: tooltip —Å –ø—Ä–∏—á–∏–Ω–æ–π –∑–∞–ø—Ä–µ—Ç–∞
- **–ê—É–¥–∏—Ç**: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç—É–ø–∞

### UX/UI
- **–ú–æ–±–∏–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω**: –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **Accessibility**: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ screen readers
- **Real-time**: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
- **Offline**: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–∞

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏—á–µ-—Ñ–ª–∞–≥–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ —á–∞—Ç
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ ACL –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- ‚úÖ FSM –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è
- ‚úÖ ACL —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
src/lib/fsm/
‚îú‚îÄ‚îÄ types.ts          # –î–æ–º–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã
‚îú‚îÄ‚îÄ schema.ts         # Zod —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ graph.ts          # –ì—Ä–∞—Ñ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ FSM
‚îú‚îÄ‚îÄ apply.ts          # –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ api.ts            # API –≤—ã–∑–æ–≤—ã
‚îî‚îÄ‚îÄ useFSM.ts         # React —Ö—É–∫

src/components/fsm/
‚îú‚îÄ‚îÄ StatusActionsV2.tsx  # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
‚îî‚îÄ‚îÄ SystemCards.tsx      # –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏

src/components/lineage/
‚îú‚îÄ‚îÄ LineagePanel.tsx     # –ü–∞–Ω–µ–ª—å lineage
‚îî‚îÄ‚îÄ LineageBadge.tsx     # –ë–µ–π–¥–∂ lineage

src/app/chat/[chatId]/ActionModals/
‚îú‚îÄ‚îÄ ReceivePartialDialog.tsx  # –ß–∞—Å—Ç–∏—á–Ω—ã–π –ø—Ä–∏—ë–º
‚îî‚îÄ‚îÄ SplitDialog.tsx           # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ
```

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

FSM —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é Sprint S11 –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.


