# CH-01 ‚Äî Media Storage Foundation - –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üéØ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –¥–ª—è —á–∞—Ç–∞ —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π –∏ S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –§–∏—á–µ-—Ñ–ª–∞–≥–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–ª–∞–≥–∏ `CHAT_MEDIA_V1` –≤ `apps/web/src/lib/flags.ts`
- ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã —Ñ–ª–∞–≥–∏ –¥–ª—è –≤—Å–µ—Ö 13 —Å–ø—Ä–∏–Ω—Ç–æ–≤ –º–µ–¥–∏–∞-—á–∞—Ç–∞

### 2. –°—Ö–µ–º–∞ –ë–î (PostgreSQL)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `chat_file` —Å –ø–æ–ª–Ω–æ–π —Å—Ö–µ–º–æ–π –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `updated_at`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `chat_file_audit` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `id`, `chat_id`, `message_id`, `uploader_id`
- `kind`, `name`, `size_bytes`, `mime`, `sha256`
- `width`, `height`, `duration_ms` (–¥–ª—è –º–µ–¥–∏–∞)
- `meta_json` (EXIF, —Å—Ç—Ä–∞–Ω–∏—Ü—ã, etc.)
- `storage_key` (S3 –ø—É—Ç—å)

### 3. Zod —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚úÖ `MediaKindSchema` - —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤ (image, video, pdf, doc, sheet, audio, other)
- ‚úÖ `FileMetadataSchema` - –±–∞–∑–æ–≤—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
- ‚úÖ `ImageMetadataSchema` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Ä–∞–∑–º–µ—Ä—ã, EXIF, –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è)
- ‚úÖ `VideoMetadataSchema` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (—Ä–∞–∑–º–µ—Ä—ã, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∫–æ–¥–µ–∫)
- ‚úÖ `AudioMetadataSchema` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∞—É–¥–∏–æ (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –±–∏—Ç—Ä–µ–π—Ç, –∫–∞–Ω–∞–ª—ã)
- ‚úÖ `DocumentMetadataSchema` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∞–≤—Ç–æ—Ä, —è–∑—ã–∫)
- ‚úÖ `UploadInitSchema` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ `UploadCompleteSchema` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ `FileUrlSchema` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö URL

### 4. API Endpoints
- ‚úÖ `POST /api/files/init` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å presigned URLs
- ‚úÖ `POST /api/files/complete` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ multipart –∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ `GET /api/files/[id]/url` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö URL —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Zod
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –ø–æ sha256+size
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è presigned URLs –¥–ª—è S3
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 5. S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- ‚úÖ `ChatMediaStorage` –∫–ª–∞—Å—Å —Å –ø–æ–ª–Ω—ã–º API
- ‚úÖ Multipart upload —Å —á–∞–Ω–∫–∞–º–∏ 5-10MB
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è presigned URLs –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤ (original, thumb, poster, hls)
- ‚úÖ `FileKeyUtils` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–∞–º–∏ —Ñ–∞–π–ª–æ–≤

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤:**
```
chats/{chatId}/{fileId}/
‚îú‚îÄ‚îÄ original          # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ thumb_{w}x{h}.webp # –ú–∏–Ω–∏–∞—Ç—é—Ä—ã
‚îú‚îÄ‚îÄ poster.jpg        # –ü–æ—Å—Ç–µ—Ä –≤–∏–¥–µ–æ
‚îî‚îÄ‚îÄ hls/             # HLS —Å–µ–≥–º–µ–Ω—Ç—ã
    ‚îú‚îÄ‚îÄ playlist.m3u8
    ‚îî‚îÄ‚îÄ segment*.ts
```

### 6. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- ‚úÖ `FileDeduplicationService` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ sha256+size —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
- ‚úÖ `FileHashUtils` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ö–µ—à–∞–º–∏ —Ñ–∞–π–ª–æ–≤
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤

### 7. Unit –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- ‚úÖ –¢–µ—Å—Ç—ã Zod —Å—Ö–µ–º (`schemas.test.ts`)
- ‚úÖ –¢–µ—Å—Ç—ã –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (`deduplication.test.ts`)
- ‚úÖ –¢–µ—Å—Ç—ã —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (`storage.test.ts`)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–æ–ª–Ω–æ–≥–æ flow (`integration.test.ts`)

**–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö —Å—Ö–µ–º
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫
- Multipart upload –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö URL
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°–ª–æ–∏ —Å–∏—Å—Ç–µ–º—ã:
1. **API Layer** - REST endpoints —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
2. **Business Logic** - –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
3. **Storage Layer** - S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
4. **Database Layer** - PostgreSQL —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –∏ –∞—É–¥–∏—Ç–æ–º

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:
```
Client ‚Üí API ‚Üí Validation ‚Üí Deduplication ‚Üí Storage ‚Üí Database
                ‚Üì
            Audit Log
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```env
S3_ENDPOINT=s3.amazonaws.com
S3_REGION=us-east-1
S3_BUCKET=bridge-media
S3_ACCESS_KEY_ID=your-key
S3_SECRET_ACCESS_KEY=your-secret
```

### –§–∏—á–µ-—Ñ–ª–∞–≥–∏:
```typescript
export const CHAT_MEDIA_V1 = true;  // –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–∞–≥
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ê—É–¥–∏—Ç:
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `chat_file_audit`
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ: CREATE, UPDATE, DELETE, DOWNLOAD
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã (–ø–æ sha256)
- –≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞ –±–ª–∞–≥–æ–¥–∞—Ä—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- –ü—Ä–æ—Ü–µ–Ω—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–ª–µ–¥—É—é—â–∏–º —Å–ø—Ä–∏–Ω—Ç–∞–º

### CH-02 (Upload Pipeline):
- ‚úÖ –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞
- ‚úÖ Multipart upload —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ Presigned URLs —Ä–∞–±–æ—Ç–∞—é—Ç

### CH-03 (Images):
- ‚úÖ –°—Ö–µ–º–∞ –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤ (thumb)
- ‚úÖ EXIF –¥–∞–Ω–Ω—ã–µ –≤ meta_json

### CH-04 (Video):
- ‚úÖ –°—Ö–µ–º–∞ –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HLS –∏ poster
- ‚úÖ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ä–∞–∑–º–µ—Ä—ã

## ‚úÖ DoD (Definition of Done)

- [x] –§–∞–π–ª —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏
- [x] –î–µ–¥—É–ø –ø–æ sha256+size (–æ—Ç–¥–∞—ë–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
- [x] –¢–µ—Å—Ç—ã: unit –Ω–∞ –∑–∞–ø–∏—Å—å/—á—Ç–µ–Ω–∏–µ, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è presigned URL, –¥–µ–¥—É–ø
- [x] –°—Ö–µ–º–∞ –ë–î —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –∏ –∞—É–¥–∏—Ç–æ–º
- [x] API endpoints —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- [x] S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- [x] –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **CH-02** - Upload Pipeline (—á–∞–Ω–∫–∏, —Ä–µ–∑—é–º, —Ä–µ—Ç—Ä–∞–∏)
2. **CH-03** - Images (–º–∏–Ω–∏–∞—Ç—é—Ä—ã, WebP/AVIF)
3. **CH-04** - Video (–ø–æ—Å—Ç–µ—Ä, HLS, —Ç—Ä–∞–Ω—Å–∫–æ–¥)
4. **CH-05** - Docs (PDF viewer, Office previews)

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
apps/web/src/lib/chat-media/
‚îú‚îÄ‚îÄ schemas.ts                    # Zod —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ storage.ts                    # S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
‚îú‚îÄ‚îÄ deduplication.ts              # –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
‚îî‚îÄ‚îÄ __tests__/
    ‚îú‚îÄ‚îÄ schemas.test.ts           # –¢–µ—Å—Ç—ã —Å—Ö–µ–º
    ‚îú‚îÄ‚îÄ deduplication.test.ts     # –¢–µ—Å—Ç—ã –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
    ‚îú‚îÄ‚îÄ storage.test.ts           # –¢–µ—Å—Ç—ã —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    ‚îî‚îÄ‚îÄ integration.test.ts       # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

apps/web/src/app/api/files/
‚îú‚îÄ‚îÄ init/route.ts                 # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
‚îú‚îÄ‚îÄ complete/route.ts             # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
‚îî‚îÄ‚îÄ [id]/url/route.ts             # –ü–æ–ª—É—á–µ–Ω–∏–µ URL —Ñ–∞–π–ª–∞

packages/db/prisma/migrations/
‚îî‚îÄ‚îÄ 2025_01_21_001_chat_media_foundation.sql
```

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

**CH-01 Media Storage Foundation** –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –°–æ–∑–¥–∞–Ω–∞ –Ω–∞–¥–µ–∂–Ω–∞—è –æ—Å–Ω–æ–≤–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —Å–ø—Ä–∏–Ω—Ç–æ–≤ –º–µ–¥–∏–∞-—á–∞—Ç–∞ —Å –ø–æ–ª–Ω—ã–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º —Ç–µ—Å—Ç–∞–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.
